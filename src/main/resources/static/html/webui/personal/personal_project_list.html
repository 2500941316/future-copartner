<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link type="text/css" rel="stylesheet" href="/html/webui/css/personal.css"/>
    <link type="text/css" rel="stylesheet" href="/html/webui/css/home.css"/>
    <script type="text/javascript" src="/html/webui/js/personal.js"></script>

    <title>我的项目</title>

    <style type="text/css">
        .tdname1:hover{
            color: red;
        }
        .tdname2:hover{
            color: red;
        }
    </style>
</head>

<body>

<div class="perRightcon">
        <div class="clear" style="margin-top: 15px"></div>
    <div class="commonTit">
        <h1 class="fl">我的项目</h1>
        <!--<div class="dqzt">
            <label>当前状态：</label>
            <span>目前处于离职状态，可即刻上岗</span>
            <span class="jticon"></span>
        </div>-->
        <div class="clear"></div>
    </div>

        <div class="jianliBox" id="tableDiv">
                <!--展示数据-->
        </div>

        <!--分页-->
        <div style="float: right">
            <div id="page"></div>
        </div>

    <div class="clear"></div>
    <div class="addJl">
        <a href="personal_project_apply.html">
            <span>继续申请项目</span>
            <!--<label>（还可申请2个项目）</label>-->
        </a>
    </div>
    <div class="clear"></div>

</div>

<script type="text/javascript">
    // 弹出层
    layui.use(['upload','layer'], function(){
        var layer = layui.layer;
        var upload = layui.upload;
    });

       $(function () {
           searchProjectByCreater();
    })

    /**
     * 分页查询我的项目
     */
    function searchProjectByCreater(pageConf) {
        if (!pageConf) {
            pageConf = {};
            pageConf.pageSize = 4; // 每页显示条数
            pageConf.currentPage = 1; // 当前页
        }
        $.get("/user/project/selectByCreater", pageConf, function (data) {
            layui.use(['laypage', 'layer'], function () {
                var page = layui.laypage;
                page.render({
                    elem: 'page',
                    count: data.count,
                    curr: pageConf.currentPage,
                    limit: pageConf.pageSize,
                    first: "首页",
                    last: "尾页",
                    layout: ['count', 'prev', 'page', 'next', 'skip'],// 'limit',
                    jump: function (obj, first) {
                        if (!first) {
                            pageConf.currentPage = obj.curr;
                            pageConf.pageSize = obj.limit;
                            searchProjectByCreater(pageConf);
                        }
                        fillProjectInfo(data.data); //页面填充
                    }
                });
            })
        })
    }

    /**
     * 填充我的项目
     * 注意每个项目上传按钮需要单独动态绑定，一个按钮对应一个id属性
     * @param projectData
     */
    function fillProjectInfo (projectData) {
        //console.log(projectData);
          const $active = $("#tableDiv");
          $active.html("");
          for(var i in projectData){
              // 计算有效元素个数百分比
              var elemCount = Object.keys(projectData[i]).length;
              // 计算元素个数百分比
              var countPercent = elemCount / 38 ;
              countPercent = countPercent.toFixed(2) * 100;

              // 计算进度条 像素px 百分比
              var linePercent = (elemCount / 38) * 200 ;
              linePercent = linePercent.toFixed(0);

              //console.log("countPercent: "+countPercent+" linePercent: "+linePercent);

              var $children = $(
                  ' <table id="myProjectTable" width="100%" border="0" cellpadding="0" cellspacing="5">\n' +
                  '            <tr id="first-tr">\n' +
                  '                <td colspan="5">\n' +
                  '                    <div class="jlpart1">\n' +
                  '                         <div class="jlName"><a href="#" onclick="viewProjectDetail('+projectData[i].projectId+')"><span id="projectName">'+ projectData[i].projectName +'</span></a></div>\n' +
                  '                         <div class="jlDate">开始时间：<span id="starttime">'+ projectData[i].starttime +'</span></div>\n' +
                  '                         <div class="jlDate">状态：<span id="projectStatus" style="font: bold">'+ projectData[i].projectStatus +'</span></div>\n' +
                  '                         <div class="jlFresh"><a href="/html/webui/personal/personal_project_list.html">更新</a></div>\n' +
                  '                    </div>\n' +
                  '                </td>\n' +
                  '            </tr>\n' +
                  '            <tr id="second-tr" >\n' +
                  '                <td width="61%">\n' +
                  '                    <div class="jlpart2">\n' +
                  '                        <div class="Orange" style="width: '+linePercent+'px;"></div>\n' +
                  '                    </div>\n' +
                  '                    <div class="jlpart3">\n' +
                  '                        完整度 '+countPercent+' %\n' +
                  '                        [ <a onclick="updateProjectInfo('+projectData[i].projectId+')" href="#">修改</a>\n' +
                  '                        <a onclick="viewProjectDetail('+projectData[i].projectId+')" href="#">查看</a> ]\n' +
                /*  '                        <a href="#">下载</a> ]</div>\n' +*/
                  '                </td>\n' +
                  '            <td rowspan="2">\n' +
                  '                       <div class="jlpart4">\n' +
                  '                          <div class="red"><i class="layui-icon layui-icon-video"></i>  </div>\n' +
                  '                          <div class="tdname"><span id="currentVideoId" style="display:none;">'+projectData[i].projectId+'</span><button type="button" class="tdname1" style="border-style: none; outline: none;background: none; cursor: pointer" id="'+5+i+'">上传视频</button></div>\n' +
                  '                       </div>\n' +
                  '                </td>\n'+
                  '            <td rowspan="2">\n' +
                  '                       <div class="jlpart4">\n' +
                  '                          <div class="red"><i class="layui-icon layui-icon-upload-drag"></i>  </div>\n' +
                  '                          <div class="tdname"><span id="currentPlanId" style="display:none;">'+projectData[i].projectId+'</span> <button type="button"  class="tdname1" style="border-style: none; outline: none;background: none; cursor: pointer"  id="'+1+i+'" >上传计划书</button></div>\n' +
                  '                       </div>\n' +
                  '                </td>\n'+
                  '                <td rowspan="2">\n' +
                  '                    <div class="jlpart4">\n' +
                  '                        <div class="delicon"></div>\n' +
                  '                        <div class="tdname2" onclick="deleteProject('+projectData[i].projectId+')" style="cursor: pointer;">删除</div>\n' +
                  '                    </div>\n' +
                  '                </td>\n' +

                  '            </tr>\n' +
                  '            <tr id="third-tr">\n' +
                  '                <td width="61%">\n' +
                  '                </td>\n' +
                  '            </tr>\n' +
                  '            <tr id="fourth-tr">\n' +
                  '                <td colspan="5">\n' +
                  '                    <div class="divline"></div>\n' +
                  '                </td>\n' +
                  '            </tr>\n' +
                  '\n' +
                  '        </table>'

           );
              $active.append($children);
              // 将上传按钮渲染到每个循环的项目中,注意要与上传所在的button标签的id值对应
              uploadPlan(1+i,projectData[i].projectId);
              uploadVideo(5+i,projectData[i].projectId)
          }
    }

    /**
     * 上传计划书
     * 动态绑定上传按钮，每个上传按钮都对应不同的id值
     */
    function uploadPlan(elemId,currentProjectId) {
       // console.log(elemId+" : "+currentProjectId)
        // 加上 # 作为动态绑定按钮的 elem值。
         elemId = "#"+elemId;

        layui.use(['upload','layer'], function() {
            var layer = layui.layer;
            var upload = layui.upload;
            // 上传计划书
            upload.render({
                elem: elemId
                , url: '/user/project/uploadPlan'
                , data: {
                    projectId: currentProjectId
                }
                , accept: 'file' //普通文件
                , done: function (res) {
                    if (res.code == 200) {
                        top.layer.msg('上传成功，等待审批！');
                        console.log(res);
                    } else {
                        top.layer.msg('网络异常');
                        console.log(res);
                    }
                }
            });
        });
    }

    /**
     * 上传视频
     * 动态绑定上传按钮，每个上传按钮都对应不同的id值
     */
    function uploadVideo(elemId,currentProjectId) {
        // 加上 # 作为动态绑定按钮的 elem值。
        elemId = "#"+elemId;

        layui.use(['upload','layer'], function() {
            var layer = layui.layer;
            var upload = layui.upload;
            //上传视频
            upload.render({
                elem: elemId
                ,url: '/user/project/uploadVideo'
                ,data: {projectId: currentProjectId}
                ,accept: 'video' //视频
                ,done: function(res){
                    if(res.code == 200){
                        top.layer.msg('上传成功，等待审批！');
                        console.log(res);
                    }else{
                        top.layer.msg('网络异常');
                        console.log(res);
                    }
                }
            });
        });
    }


    /**
     * 查看项目详情
     * @param projectId
     */
    function viewProjectDetail(projectId) {
           layer.msg("projectId:"+projectId);
        localStorage.setItem("projectId",projectId);
        //window.open("/html/webui/project/project_details_info.html");
        window.location.href = "/html/webui/project/project_details_info.html";

    }

    /**
     * 修改项目信息
     */
    function updateProjectInfo(projectId){
        localStorage.setItem("projectId", projectId);
        window.location.href = "/html/webui/project/project_update_02.html";
    }

    /**
     * 删除项目
     * @param projectId
     */
    function deleteProject(projectId) {
        top.layer.confirm('确认删除？', function (index) {
            $.ajax({
                url: '/user/project/deleteProject',
                data: "projectId="+projectId,
                type: "GET",
                success: function (res) {
                    if(res.code == 200){
                        top.layer.msg("删除成功");
                        window.location.href = "/html/webui/personal/personal_project_list.html";
                    }else{
                        top.layer.msg("网络异常")
                    }
                }
            })
            top.layer.close(index);
        });


    }




</script>

</body>
</html>