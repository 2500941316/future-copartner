<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>


    <script src='../header/header.js'></script>
    <link type="text/css" rel="stylesheet" href="../css/personal.css"/>
    <!--<script src='../js/personal.js'></script>-->
    <title>个人工作台</title>
</head>

<body>
<div class="personalBody">
    <div class="perLeftnav">
        <div class="NavLeftTop">个人中心</div>
        <div class="NavLeftMain">
            <div class="NavLeftBox active">
                <a onclick="redirecTo('../personal/personal_info.html')" class="a1" href="#">用户信息</a>
            </div>
            <div class="NavLeftBox twoNav">
                <a class="a5">项目</a>
                <span class="up"></span>
            </div>
            <ul>
                <li><a onclick="redirecTo('../personal/personal_project_apply.html')" href="#">创建项目</a></li>
                <li><a onclick="redirecTo('../personal/personal_project_list.html')" href="#">我的项目</a></li>
                <li><a onclick="redirecTo('../personal/personal_myjoin.html')" href="#">我的加入</a></li>
                <li><a onclick="redirecTo('../personal/personal_myfollow.html')" href="#">我的关注</a></li>
                <li><a onclick="redirecTo('../personal/personal_followedproject.html')" href="#">谁关注我</a></li>
            </ul>
            <div class="NavLeftBox twoNav">
                <a class="a6">帖子</a>
                <span class="up"></span>
            </div>
            <ul>
                <li><a onclick="redirecTo('../personal/personal_news_apply.html')" href="#">发布帖子</a></li>
                <li><a onclick="redirecTo('../personal/personal_mynews.html')" href="#">我的发布</a></li>
            </ul>

            <div class="NavLeftBox twoNav">
                <a class="a6">活动</a>
                <span class="up"></span>
            </div>
            <ul>
                <li><a onclick="redirecTo('../personal/personal_activity_apply.html')" href="#">创建活动</a></li>
                <li><a onclick="redirecTo('../personal/personal_activity_mycreated.html')" href="#">我的创建</a>
                </li>
            </ul>

            <div class="NavLeftBox twoNav">
                <a class="a6">邀请</a>
                <span class="up"></span>
            </div>
            <ul>
                <li><a href="#" onclick="viewInvitation()">项目邀请</a></li>
                <!--<li><a href="#">我的足迹</a></li>-->
            </ul>
           <!-- <div class="NavLeftBox">
                <a href="#" class="a7">用户设置</a>
            </div>
            <div class="NavLeftBox">
                <a href="#" class="a8">帮助中心</a>
            </div>-->
        </div>

    </div>
    <div class="perRightcon">
        <div class="perRpart1">
            <div class="perRpart1_l" id="personalImage">
                <img src="../images/per1.jpg" id="imageUrl" width="80" height="100"/>
            </div>
            <div class="perRpart1_r">
                <div class="PaName"><span id="name01"></span>您好！</div>
                <div class="PaStatus">
                    <span class="spStatus">上次登录时间：<span id="logindate"><!--2020-12-17 15:03:11--></span></span>
                </div>
                <div class="clear"></div>
                <div class="PaCon">
                    <span class="span1">用户名：<span id="name"><!--2500941316@qq.com--></span> <!--<a href="#" class="a1">[未认证]</a> <a
                        href="#" class="a2">修改密码</a>--></span>
                    <!--<span class="span2">微信： <a href="" class="a1">[未绑定]</a></span>--><br/>
                    <span class="span3">手机号：<span id="phone"><!--177*******12--></span> <a href="" class="a3">[已认证]</a>
                        <a href="#" onclick="updatePhone()" class="a2">修改</a></span>
                </div>
            </div>
            <div class="clear"></div>
            <div class="perRpart1_c">
                <div class="itemp">
                    <a href="#">
                        <span class="Title" onclick="jumpToFollowMe()">谁在关注我</span>
                        <span class="Num" id="followMe">0</span>
                    </a>
                </div>
                <div class="itemp">
                    <a href="#">
                        <span class="Title" onclick="jumpToMyProject()">我的项目</span>
                        <span class="Num" id="myProject">0</span>
                    </a>
                </div>
                <div class="itemp">
                    <a href="#">
                        <span class="Title" onclick="jumpToMyFollow()">我关注的项目</span>
                        <span class="Num" id="myFollow">0</span>
                    </a>
                </div>
                <div class="itemp">
                    <a onclick="viewInvitation()" href="#">
                        <span class="Title">邀请函</span>
                        <span class="Num" id="myInvitation">0</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!--查看邀请函信息表格-->
    <div id="invitationInfo" style="display: none;text-align: center" >
        <table id="invitationTable" lay-filter="invitationTable"></table>

        <script type="text/html" id="invitationOperate">
            <a class="layui-btn layui-btn-xs" lay-event="pass">同意</a>
            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="reject">拒绝</a>
        </script>
    </div>

</div>

<iframe scrolling="no" name="aa" id="iframe" width="900px" frameborder="0"
        src="#"
        onload="this.height=0;var fdh=(this.Document?this.Document.body.scrollHeight:this.contentDocument.body.offsetHeight);
        this.height=(fdh>600?fdh:600)"></iframe><!--this.height=(fdh>600?fdh:600)-->

<!--引入页脚页面-->
<div style="bottom:0;" id="footer"></div>

<script type="text/javascript">
    var $ = layui.jquery;

    $(function () {
        redirecTo("../personal/personal_info.html");

        // 根据标志位来进行url监听，如果来自项目页，则直接跳转到创建项目页
        var label = localStorage.getItem("project.html");
        if (label === "1") {
            redirecTo("../personal/personal_project_apply.html");
        }
        localStorage.setItem("project.html", 0); // 复原标志位

        $("#footer").load("/html/webui/footer/footer.html");

        selectCount();
        selectPersonalInfo();
    });

    // 弹出层
    layui.use('layer', function () {
        var layer = layui.layer;
    })

    function redirecTo(url) {
        /*公共部分：登录弹框*/
        iframe.src = url;
    }

    //上传个人图片
    layui.use('upload', function () {
        var $ = layui.jquery
            , upload = layui.upload;
        //普通图片上传
        var uploadInst = upload.render({
            elem: '#personalImage'
            , url: '/vip/user/uploadPersonalImage'
            ,accept: 'images'
            , before: function(obj) {
                layer.load();
            }
            ,done: function (res) {
                layer.closeAll('loading');
                if (res.code === 200) {
                     top.layer.msg('上传成功');
                }else{
                    layer.msg("网络异常！");
                }
            }, error: function () {
            }
        });
    })

    /**
     * 查询我的项目，我的关注，关注我的个数
     */
    function selectCount() {
        $.ajax({
            url: "/vip/project/selectCount",
            async: true,
            type: "GET",   //请求方式
            success: function (req) {
                if (req.code == 200) {
                    //console.log(req);
                    fillCount(req.data)
                } else {
                    layer.msg("网络异常，请稍后重试！")
                }
            }
        })
    }

    /**
     * 填充个数
     * @param info
     */
    function fillCount(info) {
        document.getElementById("myFollow").innerText = info.countOfMyFollow;
        document.getElementById("myProject").innerText = info.countOfProject;
        document.getElementById("followMe").innerText = info.countOfFollowMe;
        document.getElementById("myInvitation").innerText = info.countOfMyInvitation;
    }

    /**
     * 查询我的信息
     */
    function selectPersonalInfo() {
        $.ajax({
            url: "/vip/user/selectPersonalInfo",
            async: true,
            type: "GET",   //请求方式
            success: function (req) {
                if (req.code == 200) {
                    // console.log(req);
                    if (req.data != null) {
                        fillPersonalInfo(req.data[0]);
                    }
                } else {
                    layer.msg("网络异常，请稍后重试！")
                }
            }
        })
    }

    function fillPersonalInfo(info) {
        document.getElementById("logindate").innerText = info.logindate;
        document.getElementById("name").innerText = info.name;
        document.getElementById("name01").innerText = info.name+",";
        document.getElementById("phone").innerText = info.phone;
        if(info.imageUrl != null){
            document.getElementById("imageUrl").src = info.imageUrl;
        }
    }

    /**
     * 跳转到相应的路径
     */
    function jumpToFollowMe(){
        if(document.getElementById("followMe").innerText === "0"){
            layer.msg("无数据",{icon: 7,shade: 0.01,time: 1000})
        }else{
            redirecTo("../personal/personal_followedproject.html");
        }
    }
    function jumpToMyProject(){
        if(document.getElementById("myProject").innerText  === "0"){
            layer.msg("无数据",{icon: 7,shade: 0.01,time: 1000})
        }else{
            redirecTo("../personal/personal_project_list.html");
        }
    }
    function jumpToMyFollow(){
        if( document.getElementById("myFollow").innerText === "0"){
            layer.msg("无数据",{icon: 7,shade: 0.01,time: 1000})
        }else{
            redirecTo("../personal/personal_myfollow.html");
        }
    }

    /**
     * 查询邀请函
     */
    function viewInvitation() {
        //邀请函信息
        var table = layui.table;
      /*  var data = [{
            projectId: "1",
            projectName: '张三',
            inviterName: '11011011011',
            inviteDate: '2021-01-01'
        }];*/
        // 邀请函信息表格
        table.render({
            elem: '#invitationTable',
            url: '/vip/project/searchInvitationInfo',
            //where: {projectId: localStorage.getItem("projectIdForMember")},
            //   , height: 580
            //data: data,
            title: '邀请信息',
            cols: [[
                {field: 'memberId', title: 'ID', fixed: 'left', width: 60,unresize: true, sort: true, align: 'center', type: 'numbers'},
                {field: 'projectName', title: '项目名', width: 150,align: 'center'},
                {field: 'inviterName', title: '邀请人', width: 150,align: 'center'},
                {field: 'inviteDate', title: '邀请时间',width: 150, align: 'center'},
                {fixed: 'right', title: '操作', toolbar: '#invitationOperate', width: 150, align: 'center'}

            ]],
            page: true,
            limits: [10],
            width: 669,
        });
        //监听工具条
        table.on('tool(invitationTable)', function (obj) {
            var data = obj.data;
            if (obj.event === 'pass') {
                handleInvitationInfo(data.memberId,1); // 1代表同意
                obj.del();
            } else if (obj.event === 'reject') {
                handleInvitationInfo(data.memberId,2); // 2代表拒绝
                obj.del();
            }
        });

        //打开弹出框表格信息
        layer.open({
            type:1,
            area:['670px','70%'],
            title: '项目邀请加入信息',
            content: $("#invitationInfo"),
            shade: 0.01,
            cancel: function(layero,index){
                layer.closeAll();
            }
        });
    }

    /**
     * 处理邀请函信息，同意或者拒绝
     * @param memberId
     * @param isAudit
     */
    function handleInvitationInfo(memberId,mark) {
        var handleInfo={
            memberId : memberId,
            isAudit: mark
        }
        $.ajax({
            url: '/vip/project/handleInvitationInfo',
            data: handleInfo,
            type: "GET",
            success: function (res) {
                if(res.code == 200){
                    top.layer.msg("已处理",{icon: 1,shade: 0.05,time: 1000});
                }else{
                    top.layer.msg("网络异常")
                }
            }
        })
    }

    /**
     * 输入字数限制
     * @param thisArea
     * @param maxLength
     */
    function textLimitCheck(thisArea, maxLength) {
        if (thisArea.value.length > maxLength) {
            thisArea.value = thisArea.value.substring(0, 11);
            thisArea.focus();
        }
        messageCount.innerText = thisArea.value.length;
    }

    /**
     * 修改手机号弹出框
     */
    function updatePhone(){
        //打开弹出框
        layer.prompt({
            formType: 0,
            value: '',
            title: '请输入新的手机号',
            maxlength: 11
            // area: ['800px', '350px'] //自定义文本域宽高
        }, function (value, index) {
            if(isNaN(value)){
                layer.msg("请输入正确的数字！",{icon: 7,shade: 0.05,time: 1000});
                return;
            }else{
                if(value.length < 11){
                    layer.msg("请输入11位手机号！",{icon: 7,shade: 0.05,time: 1000})
                    return;
                }else{
                    //console.log(value);
                    handleUpdatePhone(value);
                }
            }
            layer.close(index);
        });
    }

    /**
     * 修改手机号处理
     * @param phone
     */
    function handleUpdatePhone(phone) {
        $.ajax({
            url: '/vip/user/handleUpdatePhone',
            data: 'newPhone='+phone,
            type: "GET",
            success: function (res) {
                if(res.code == 200){
                    top.layer.msg("修改成功！请重新登录生效",{icon: 1,shade: 0.05,time: 2000});
                }else{
                    top.layer.msg("网络异常!");
                }
            },
            error: function (res) {
                console.log(res);
                top.layer.msg("网络异常！");
            }
        })

    }
</script>

</body>
</html>
