<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>个人工作台</title>
    <script src='/html/webui/header/header.js'></script>
    <link rel="stylesheet" type="text/css" href="/html/managerui/css/layout.css"/>
    <link rel="stylesheet" type="text/css" href="/html/managerui/css/hyzx.css"/>
    <link type="text/css" rel="stylesheet" href="/html/webui/css/home.css"/>
    <link rel="stylesheet" type="text/css" href="/html/managerui/js/layui/css/layui.css"/>
    <script type="text/javascript" src="/html/managerui/js/layui/layui.js"></script>
    <script type="text/javascript" src="/html/managerui/js/leasson_manager.js"></script>
</head>
<body>
<!--引入页头页面-->
<div id="hy_con">
    <div id="con_lf">
        <h2>管理列表</h2>
        <ul>
            <li class="lf_li1"><a href="/html/managerui/index.html">申请审批</a></li>
            <li class="lf_li1"><a href="/html/managerui/html/user/user_manager.html">人员管理</a></li>
            <li class="lf_li1"><a href="/html/managerui/html/project/project_manager.html">项目管理</a></li>
            <li class="lf_li1"><a href="#">新闻管理</a></li>
            <li class="lf_li1"><a href="/html/managerui/html/leasson/leasson_manager.html">课程管理</a></li>
            <li class="lf_li1"><a href="/html/managerui/html/supervisor/supervisor_manager.html">导师管理</a></li>
            <li class="lf_li1"><a href="/html/managerui/html/activity/activity_manager.html">活动管理</a></li>
            <li class="lf_li1"><a href="/html/managerui/html/live/live_manager.html">直播管理</a></li>
        </ul>
    </div>
    <div id="con_rh">
        <div class="con_rh_con">
            <p class="rh_title">活动管理</p>
            <div class="layui-tab" lay-filter="demo">
                <ul class="layui-tab-title">
                    <li class="layui-this" onclick="searchActivityInfo()">活动信息管理</li>
                    <!--<li class="layui-this" onclick="supervisorInfoManage()">导师信息管理</li>-->
                </ul>
                <div class="layui-tab-content">
                    <div class="layui-tab-item layui-show">
                        <!--引入layui表格-->
                        <table id="activity" lay-filter="activityTable"></table>

                        <script type="text/html" id="activityOperate">
                            <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>
                            <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="manage">发布</a>
                            <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="people" style="background-color: #6f42c1">人员</a>
                            <a class="layui-btn layui-btn-xs" lay-event="edit">修改</a>
                            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delete">删除</a>
                        </script>

                    </div>

                    <!--导师信息管理模块-->
                    <!--<div class="layui-tab-item">
                    </div>-->

                    <!--发布操作弹出框-->
                    <form class="layui-form" id="test" style="display:none">
                        <div class="layui-form-item">
                            <label class="layui-form-label">状态：</label>
                            <div class="layui-input-block">
                                <input type="radio" name="type" value="1" title="发布" checked>
                                <input type="radio" name="type" value="0" title="撤回">
                            </div>
                        </div>
                    </form>

                    <!--查看报名人员操作弹出框-->
                    <div id="displayBox" style="display:none; padding: 10px;">
                        <table id="displayBoxTable" lay-filter="displayBoxTable" align="center"></table>
                    </div>
                </div>
            </div>
        </div>


    </div>
</div>

<!--引入尾部页面-->
<div id="footer"></div>


<script type="application/javascript">
    $(function () {
        $("#footer").load("/html/webui/footer/footer.html");

        searchActivityInfo();
    })

    /**
     *活动信息管理表格
     */
    function searchActivityInfo(){
        layui.use('table', function () {
            var table = layui.table;

            table.render({
                elem: '#activity'
                , url: '/manager/activity/searchAllActivity'
                //,data: data
                , title: '活动信息管理表'
                , cols: [[
                    /*{
                        field: 'activityId', title: 'ID', fixed: 'left', width: 80,unresize: true, sort: true, align: 'center',type:'numbers'
                    }*/
                     {field: 'activityTitle', title: '活动标题',width:150, align: 'center'}
                    , {field: 'activityAuthor', title: '创建人', align: 'center'}
                    , {field: 'startTime', title: '开始时间',width:150,align: 'center'}
                    , {field: 'isPublish', title: '状态', sort: true, align: 'center',templet: function(res){
                        if(res.isPublish === 0){ return  '未发布';}
                        else if(res.isPublish === 1){ return  '已发布';}
                        }}
                    , {fixed: 'right', title: '操作', toolbar: '#activityOperate', width: 260, align: 'center'}
                ]]
                , page: true
                ,limits: [10]
            });
            //监听操作栏
            table.on('tool(activityTable)', function (obj) {
                var activityData = obj.data;
                if (obj.event === 'detail') {
                    viewActivityInfo(activityData.activityId);
                } else if (obj.event === 'edit') {
                    editActivityInfo(activityData.activityId);
                } else if (obj.event === 'delete') {
                    layer.confirm('确认删除？', function (index) {
                        deleteActivityInfo(activityData.activityId);
                        layer.close(index);
                        obj.del();
                    });
                } else if(obj.event === 'manage'){
                    // 活动发布或撤回
                    manageActivityInfo(obj.data);
                } else if(obj.event === 'people'){
                    // 查看活动报名人员
                    viewEnrolledPeople(activityData.activityId);
                }

            });
        })
    }


   /**
    *查看活动信息
    * */
    function viewActivityInfo(activityId) {
        localStorage.setItem("activityId", activityId);
        layui.use("layer", function () {
            var layer = layui.layer;
            layer.open({
                type: 2,
                area: ["90%", "100%"],
                fixed: false, //不固定
                maxmin: true,
                content: "/html/webui/activity/activity_detail.html"
            });
        });
    }

    /**
     * 删除活动
     * @param activityId
     */
    function deleteActivityInfo(activityId) {
        $.ajax({
            url: "/manager/activity/deleteActivityById",
            type: "GET",
            data: "activityId="+activityId,
            success: function (res) {
                if(res.code = 200){
                    layer.msg("删除成功！", {icon: 1,shade: 0.1,time: 2000})
                }else{
                    layer.msg("网络异常！");
                }
            }
        })
    }

    /**
     * 修改活动信息
     * @param activityId
     */
    function editActivityInfo(activityId) {
        localStorage.setItem("activityId",activityId);
        layui.use("layer", function () {
            var layer = layui.layer;
            layer.open({
                title:"活动信息修改",
                type: 2,
                area: ["70%", "100%"],
                fixed: false, //不固定
                maxmin: true,
                content: "/html/managerui/html/activity/activity_edit.html"
            });
        });
    }

    /**
     * 发布活动
     * @param projectId
     */
    function manageActivityInfo(info) {
        layer.open({
            type:1,
            area:['30%','25%'],
            title: '活动状态设置'
            ,content: $("#test"),
            shade: 0.1,
            btn: ['提交']
            ,btn1: function(index, layero){
                // 获取选中的状态值
                var typeValue = $('#test input[name="type"]:checked ').val()
                if(typeValue == info.isPublish){
                    layer.msg("状态重复", {icon: 2,shade: 0.1,time: 2000,shift: 6});
                    layer.close(index);
                    return;
                }
                updateActivityStatus(info.activityId,typeValue);
                layer.close(index);
            },
            cancel: function(layero,index){
                layer.closeAll();
            }
        });
    }

    /**
     * 更新活动状态
     * @param activityId
     * @param isPublish
     */
    function updateActivityStatus(activityId,isPublish){
        var updateData = {
            activityId: activityId,
            isPublish: isPublish
        }
        $.ajax({
            url: "/manager/activity/updateActivityStatus",
            type: "GET",
            data: updateData,
            success: function (res) {
                if(res.code = 200){
                    layer.msg("设置成功！",{icon: 1,shade: 0.1,time: 2000})
                    searchActivityInfo(); // 刷新表格
                }else{
                    layer.msg("网络异常！");
                }
            }
        })
    }

    /**
     * 查看活动报名人员
     * @param activityId
     */
    function viewEnrolledPeople(activityId) {
        //活动报名人员表格
        layui.use('table', function () {
            var table = layui.table;
            var high = 40; //表头高度
            table.render({
                elem: '#displayBoxTable'
                , url: '/manager/activity/searchEnrolledPeople'
                ,where: {activityId: activityId}
                , title: '活动已报名人员'
                ,smartReloadModel:true
                , cols: [[
                    {field: 'activityId',title: '序号', width: 100, align: 'center',type: 'numbers' },
                    {field: 'personId', title: '账号',width: 160, align: 'center'},
                    {field: 'personName', title: '姓名',width: 160, align: 'center'},
                    {field: 'enrollTime', title: '报名时间',width: 160, align: 'center'}
                ]]
                , page: true
                , limits: [10]
                , done: function(count){
                    $("table").css("width", "100%");//宽度
                    high = high + count * 40;//一条数据的高度是40
                    layer.open({
                        type: 1,
                        title: '报名详情：',
                        shade: 0.1,
                        /*offset: '100px',*/
                        area: ['605px', high+'px'], //宽高
                        content: $('#displayBox')
                    });
                }
            });
        })
    }

</script>

</body>
</html>
