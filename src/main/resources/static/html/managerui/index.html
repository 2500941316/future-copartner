<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>个人工作台</title>
    <link rel="stylesheet" type="text/css" href="css/layout.css"/>
    <link rel="stylesheet" type="text/css" href="css/hyzx.css"/>
    <link rel="stylesheet" type="text/css" href="/html/managerui/js/layui/css/layui.css"/>
    <script type="text/javascript" src="/html/webui/js/jquery-1.8.2.min.js"></script>
    <script type="text/javascript" src="/html/managerui/js/layui/layui.js"></script>

</head>
<body>
<!--引入页头页面-->
<div id="headers" style="margin-bottom: 20px"></div>

<div id="hy_con">
    <div id="con_lf">
        <h2>管理列表</h2>
        <ul>
            <li class="lf_li1"><a href="/html/managerui/index.html">申请审批</a></li>
            <li class="lf_li1"><a href="#">项目管理</a></li>
            <li class="lf_li1"><a href="#">新闻管理</a></li>
            <li class="lf_li1"><a href="/html/managerui/html/leasson/leasson_manager.html">课程管理</a></li>
        </ul>
    </div>
    <div id="con_rh">
        <div class="con_rh_con">
            <p class="rh_title">申请审批</p>
            <div class="layui-tab">
                <ul class="layui-tab-title">
                    <li class="layui-this"  onclick="searchProjectApplication()">项目申请</li>
                    <li class="layui-this" onclick="searchNewsApplication()">新闻申请</li>
                    <li class="layui-this">申请</li>
                </ul>
                <div class="layui-tab-content">
                    <div class="layui-tab-item layui-show">
                        <!--引入layui表格-->
                        <table id="project" lay-filter="projectTable"></table>

                        <script type="text/html" id="projectOperate">
                            <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>
                            <a class="layui-btn layui-btn-xs" lay-event="pass">通过</a>
                            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="reject">驳回</a>
                        </script>

                    </div>

                    <!--新闻审核表-->
                    <div class="layui-tab-item">
                        <table class="layui-hide" id="new" lay-filter="new"></table>
                        <script type="text/html" id="switchTpl">
                            <input type="checkbox" name="sex" value="{{d.id}}" lay-skin="switch" lay-text="是|否"
                                   lay-filter="sexDemo" {{ d.id== 10003 ? 'checked' : '' }} >
                        </script>
                        <script type="text/html" id="barDemo">
                            <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="view">查看</a>
                            <a class="layui-btn layui-btn-xs" lay-event="pass">通过</a>
                            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="reject">驳回</a>
                        </script>
                    </div>
                    <div class="layui-tab-item">内容3</div>
                </div>
            </div>
        </div>
    </div>
</div>


<!--引入尾部页面-->
<div id="footer"></div>

<!--公告跳转模块-->
<script type="text/javascript">
    $(function () {
        $("#headers").load("/html/webui/header/header.html");
        $("#footer").load("/html/webui/footer/footer.html");
    });

    //tab标签页引用
    layui.use('element', function () {
        var element = layui.element;
    });
</script>


<!--项目申请的js模块-->
<script type="text/javascript">

    function searchProjectApplication() {
        //项目申请tab表格的使用
        layui.use('table', function () {
            var table = layui.table;
            var data = [{
                id: "11221",
                projectName: '项目名称',
                type: '测试是否溢出表格1111111111111',
                description: '测试是否溢出表格11111111111'
            }];
            // 项目申请审批表格
            table.render({
                elem: '#project'
                , url: '/manager/project/searchProject'
                //   , height: 580
                //   ,data: data
                , title: '项目审批表格'
                , cols: [[
                    {field: 'projectId', title: 'ID', fixed: 'left', unresize: true, sort: true}
                    , {field: 'projectName', title: '项目名'}
                    , {field: 'projectCreater', title: '创建人', width: 80}
                    , {field: 'projectType', title: '类型', width: 80, sort: true}
                    , {field: 'description', title: '项目简述', overflow: 'hidden'}
                    , {field: 'projectStatus', title: '状态', width: 80, sort: true}
                    , {field: 'starttime', title: '开始时间'}
                    , {fixed: 'right', title: '操作', toolbar: '#projectOperate', width: 180, align: 'center'}
                ]]
                , page: true
            });
            //监听工具条
            table.on('tool(projectTable)', function (obj) {
                var data = obj.data;
                if (obj.event === 'detail') {
                    viewProject(obj.data.projectId)
                    // layer.alert('详情：&lt;br>' + JSON.stringify(data))
                } else if (obj.event === 'pass') {
                    layer.confirm('通过该项目申请？', function (index) {
                        operateProject(obj, 1,"");
                        layer.close(index);
                    });
                }else if(obj.event === 'reject'){
                    layer.prompt({
                        formType: 2,
                        value: ' ',
                        title: '请输入驳回原因'
                        // area: ['800px', '350px'] //自定义文本域宽高
                    }, function(value, index){
                        alert(value); //得到value
                        operateProject(obj, 2, value);
                        layer.close(index);
                    });
                }
            });
        });
    }

    //查看项目申请内容
    function viewProject(projectId) {
        localStorage.setItem("projectId", projectId);
        layui.use("layer", function () {
            var layer = layui.layer;
            var index = layer.open({
                type: 2,
                title: ['项目详情', 'font-size:18px; color:orange;'],//数组第二项可以写任意css样式；如果你不想显示标题栏，你可以title: false
                content: '/html/webui/project/project_apply_info.html',
                area: ["50%", "50%"],
                btn: ['返回'],
                yes: function(index, layero){
                    layer.close(index); //如果设定了yes回调，需进行手工关闭
                }
            });
        })
    }

    // 通过或者驳回项目申请
    function operateProject(currentProject,status, msg){
        let operation ={
            taskId: currentProject.data.taskId,
            projectId: currentProject.data.projectId,
            isAudit: status,
            projectAuditMsg: msg
        }
        console.log(operation);

        $.ajax({
            url: "/manager/project/operateProjectApply",    //请求的url地址
            dataType: "json",   //返回格式为json
            contentType: "application/json",
            async: true, //请求是否异步，默认为异步，这也是ajax重要特性
            data: JSON.stringify(operation),   //参数值
            type: "POST",   //请求方式
            success: function(res) {
                //请求成功时处理，一般只用到这一个
                if(res.code == 200){
                    layer.msg("审核完成！")
                }else{
                    layer.msg("网络异常，请稍后重试！")
                }
            },
            error: function(req) {
                //请求出错处理
                console.log(req);
                layer.msg('参数异常');
            }
        });


    }
</script>


<!--新闻申请模块的js-->
<script type="text/javascript">

    //新闻申请tab表格的使用
    function searchNewsApplication() {
        layui.use('table', function () {
            var table = layui.table
                , form = layui.form;

            table.render({
                elem: '#new'
                , url: '/manager/news/searchNewsApplication'
                , cols: [[
                    {field: 'newsTitle', title: '标题', width: 130, align: 'center'},
                    {field: 'newsAuthor', title: '发布人', width: 110, align: 'center'},
                    {field: 'newsCategory', title: '种类', width: 110, align: 'center'},
                    {field: 'newsPublistime', title: '发布时间', width: 150, sort: true, align: 'center'},
                    {field: 'istopping', title: '置顶', align: 'center', width: 80, templet: '#switchTpl'},
                    {fixed: 'right', title: '操作', align: 'center', toolbar: '#barDemo'}
                ]]
                , page: true
            });

            //监听性别操作
            form.on('switch(sexDemo)', function (obj) {
                layer.tips("更改置顶项" + obj.othis);
            });

            //监听行工具事件
            table.on('tool(new)', function (obj) {
                var data = obj.data;
                if (obj.event === 'pass') {
                    layer.confirm('批准该新闻上线？', function (index) {
                        operateNew(obj, 1, "");
                        layer.close(index);
                    });
                } else if (obj.event === 'reject') {
                    layer.prompt({
                        formType: 2
                        , value: data.email
                    }, function (value, index) {
                        operateNew(obj, 0, value);
                        layer.close(index);
                    });
                } else if (obj.event === 'view') {
                    alert("view")
                }
            });
        });
    }

    //点击查看新闻按钮，打开一个对话框
    function viewNew(newsId) {
        localStorage.setItem("newsId", newsId);
        layui.use("layer", function () {
            var layer = layui.layer;
            layer.open({
                type: 2,
                area: ["90%", "100%"],
                fixed: false, //不固定
                maxmin: true,
                content: "/html/webui/news/news_content.html"
            });
        });
    }


    //通过或者驳回新闻申请的方法:通过为1，驳回为2
    function operateNew(thisNew, isaudit, newsAdvice) {
        var data = {
            taskId: "1232132",
            status: status,
            msg: msg,
        };

        $.ajax({
            type: "POST",
            url: "/manager/news/operateNew",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (data) {
                if (data.code === 200) {

                    layer.msg('操作成功', function () {
                    });
                    thisNew.del();
                } else
                    layer.msg('网络异常，请稍后重试');
            },
            error: function (data) {
                layer.msg('参数异常');
            }
        });
    }

</script>

</body>
</html>
